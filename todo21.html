<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>To-Do iPhone UX</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css">
<style>
:root {
  --bg: #f5f7fa;
  --card: #fff;
  --accent: #007AFF;
  --text: #1c1c1e;
  --shadow: rgba(0,0,0,0.1);
}
body.dark {
  --bg: #121212;
  --card: #1c1c1c;
  --accent: #0A84FF;
  --text: #f5f5f5;
  --shadow: rgba(255,255,255,0.15);
}
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
  transition: background .3s ease, color .3s ease;
}
header {
  flex-shrink: 0;
  height: 60px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 18px;
  background: var(--card);
  box-shadow: 0 1px 6px var(--shadow);
}
header h1 {
  font-size: 1.1rem;
  font-weight: 600;
}
#theme-toggle {
  background: none;
  border: none;
  font-size: 22px;
  color: var(--accent);
  cursor: pointer;
}
main {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px 80px;
  box-sizing: border-box;
  -webkit-overflow-scrolling: touch;
}
.clock {
  text-align: center;
  font-size: 0.9rem;
  opacity: 0.6;
  margin-bottom: 8px;
}
.input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}
.input-row input[type=text] {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1rem;
}
.input-row input[type=number] {
  width: 70px;
  border-radius: 10px;
  border: 1px solid #ccc;
  text-align: center;
}
.task {
  background: var(--card);
  border-radius: 16px;
  padding: 14px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 8px var(--shadow);
  transition: transform 0.2s cubic-bezier(.34,1.56,.64,1), background 0.3s;
}
.task.dragging { transform: scale(1.03); opacity: 0.8; }
.task.done label { text-decoration: line-through; opacity: 0.5; }
.task-left {
  display: flex;
  align-items: center;
  flex: 1;
  min-width: 0;
}
.checkbox {
  width: 26px; height: 26px; border-radius: 50%;
  border: 2px solid var(--accent);
  display: flex; align-items: center; justify-content: center;
  color: white; font-size: 15px; cursor: pointer; flex-shrink: 0;
}
.checkbox.checked { background: var(--accent); }
label {
  margin-left: 10px;
  font-size: 1rem;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.task-info {
  font-size: 0.8rem;
  opacity: 0.7;
  text-align: right;
  margin-left: 8px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}
.task-info input {
  width: 55px;
  text-align: right;
  border: none;
  background: transparent;
  color: var(--text);
  font-size: 0.8rem;
  border-bottom: 1px dashed #aaa;
}
.task-info input:focus { outline: none; border-bottom: 1px solid var(--accent); }
.delay { color: #ff3b30; font-size: 0.75rem; margin-top: 2px; }
.delete-btn {
  background: none; border: none;
  font-size: 20px; color: #aaa; cursor: pointer; margin-left: 8px;
  transition: transform 0.2s;
}
.delete-btn:active { transform: scale(0.9); color: #e74c3c; }
nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: 70px; background: var(--card);
  display: flex; justify-content: space-around; align-items: center;
  box-shadow: 0 -1px 8px var(--shadow);
  border-top-left-radius: 16px; border-top-right-radius: 16px;
}
nav button {
  background: none; border: none;
  color: var(--accent); font-size: 26px; cursor: pointer;
}
nav input[type=file] { display: none; }
</style>
</head>
<body>
<header>
  <h1>Ma To-Do</h1>
  <button id="theme-toggle">üåô</button>
</header>

<main>
  <div class="clock" id="clock"></div>
  <div class="input-row">
    <input id="task-input" type="text" placeholder="Nouvelle t√¢che...">
    <input id="duration-input" type="number" min="1" value="5">
  </div>
  <div id="task-list"></div>
</main>

<nav>
  <button id="clean-btn">üßπ</button>
  <button id="toggle-done-btn">üëÅÔ∏è</button>
  <button id="export-btn">üíæ</button>
  <button id="import-btn">üìÇ</button>
  <input type="file" id="file-input" accept=".json">
</nav>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const clock = document.getElementById("clock");
const themeToggle = document.getElementById("theme-toggle");
const taskList = document.getElementById("task-list");
const taskInput = document.getElementById("task-input");
const durationInput = document.getElementById("duration-input");
const cleanBtn = document.getElementById("clean-btn");
const toggleDoneBtn = document.getElementById("toggle-done-btn");
const exportBtn = document.getElementById("export-btn");
const importBtn = document.getElementById("import-btn");
const fileInput = document.getElementById("file-input");

let hideDone = false;

function updateClock() {
  clock.textContent = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();

themeToggle.onclick = () => {
  document.body.classList.toggle("dark");
  themeToggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
};

function saveTasks() {
  const data = [...taskList.children].map(t => ({
    text: t.querySelector("label").textContent,
    done: t.classList.contains("done"),
    duration: parseInt(t.dataset.duration),
    start: t.dataset.start || new Date().toISOString()
  }));
  localStorage.setItem("tasks", JSON.stringify(data));
}

function loadTasks() {
  const data = JSON.parse(localStorage.getItem("tasks") || "[]");
  taskList.innerHTML = "";
  data.forEach(t => createTask(t.text, t.duration, t.done, t.start));
  updateTimes();
}

function createTask(text, duration=5, done=false, start=null) {
  const div = document.createElement("div");
  div.className = "task";
  div.dataset.duration = duration;
  div.dataset.start = start || new Date().toISOString();
  if(done) div.classList.add("done");

  const left = document.createElement("div");
  left.className = "task-left";

  const checkbox = document.createElement("div");
  checkbox.className = "checkbox" + (done ? " checked" : "");
  checkbox.innerHTML = done ? "‚úî" : "";
  checkbox.onclick = () => {
    const wasDone = div.classList.toggle("done");
    checkbox.classList.toggle("checked");
    checkbox.innerHTML = wasDone ? "‚úî" : "";
    saveTasks();
    updateTimes();
  };

  const label = document.createElement("label");
  label.textContent = text;
  left.append(checkbox, label);

  const info = document.createElement("div");
  info.className = "task-info";
  const durInput = document.createElement("input");
  durInput.type = "number";
  durInput.min = "1";
  durInput.value = duration;
  durInput.onchange = () => {
    div.dataset.duration = durInput.value;
    saveTasks();
    updateTimes();
  };
  const delay = document.createElement("span");
  delay.className = "delay";

  info.append(durInput, delay);

  const del = document.createElement("button");
  del.className = "delete-btn";
  del.textContent = "üóëÔ∏è";
  del.onclick = () => { div.remove(); saveTasks(); updateTimes(); };

  div.append(left, info, del);
  taskList.append(div);
  saveTasks();
  updateTimes();
}

/* Drag & Drop */
new Sortable(taskList, {
  animation: 150,
  onEnd: () => { saveTasks(); updateTimes(); }
});

/* Ajout automatique */
taskInput.addEventListener("keypress", e => {
  if (e.key === "Enter") {
    const txt = taskInput.value.trim();
    if (!txt) return;
    const dur = parseInt(durationInput.value) || 5;
    createTask(txt, dur);
    taskInput.value = "";
    durationInput.value = 5;
  }
});

/* Calcul du temps estim√© et des retards */
function updateTimes() {
  const tasks = [...taskList.children];
  let current = new Date();
  tasks.forEach(task => {
    const duration = parseInt(task.dataset.duration);
    const start = new Date(task.dataset.start);
    const estEnd = new Date(start.getTime() + duration * 60000);
    const delayEl = task.querySelector(".delay");
    const now = new Date();

    let display = `${duration} min`;
    if (task.classList.contains("done")) {
      const doneAt = now;
      const diff = (doneAt - estEnd) / 60000;
      if (diff > 0) display += ` ‚Ä¢ +${Math.round(diff)} min`;
      delayEl.textContent = diff > 0 ? `Retard: +${Math.round(diff)} min` : "";
    } else {
      delayEl.textContent = "";
      display += ` ‚Ä¢ fin estim√©e ${estEnd.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
    }

    if (hideDone && task.classList.contains("done")) {
      task.style.display = "none";
    } else {
      task.style.display = "flex";
    }

    task.querySelector(".task-info input").title = display;
  });
}

/* Cacher/afficher les termin√©es */
toggleDoneBtn.onclick = () => {
  hideDone = !hideDone;
  toggleDoneBtn.textContent = hideDone ? "üôà" : "üëÅÔ∏è";
  updateTimes();
};

/* Nettoyage */
cleanBtn.onclick = () => {
  if (!confirm("Supprimer les t√¢ches termin√©es ?")) return;
  [...taskList.children].forEach(t => { if (t.classList.contains("done")) t.remove(); });
  saveTasks();
  updateTimes();
};

/* Export / Import */
exportBtn.onclick = () => {
  const data = localStorage.getItem("tasks") || "[]";
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "todo.json"; a.click();
  URL.revokeObjectURL(url);
};
importBtn.onclick = () => fileInput.click();
fileInput.onchange = e => {
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    try {
      const data = JSON.parse(r.result);
      localStorage.setItem("tasks", JSON.stringify(data));
      loadTasks();
      alert("Import r√©ussi !");
    } catch { alert("Fichier invalide."); }
  };
  r.readAsText(f);
};

loadTasks();
</script>
</body>
</html>
